services:
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tally-tailscale
    hostname: tally
    environment:
      # No TS_AUTHKEY = shows login link in logs (check within 60 seconds!)
      # To use auth key instead, uncomment and set:
      # - TS_AUTHKEY=tskey-auth-xxxxx
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true  # Required for macOS (no /dev/net/tun)
      - TS_SERVE_CONFIG=/config/serve.json
    ports:
      # Local access (web container shares this network)
      - "3000:3000"
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./tailscale-config:/config:ro
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tally-web
    network_mode: service:tailscale
    depends_on:
      - tailscale
    env_file:
      - .env
    environment:
      # These override .env for Docker-specific paths
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - DATABASE_PATH=/app/data/app.db
      - BUCKET_STORAGE_PATH=/app/data/uploads
    volumes:
      - tally-data:/app/data
    restart: unless-stopped

volumes:
  tally-data:
  tailscale-state:
