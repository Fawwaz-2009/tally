# Production Docker Compose for Tally
# This file pulls pre-built images from GitHub Container Registry
#
# Quick start:
#   1. Copy .env.example to .env and configure
#   2. Run: docker compose -f docker-compose.prod.yml up -d
#   3. Check logs for Tailscale login link: docker compose -f docker-compose.prod.yml logs tailscale
#
# Update to latest:
#   docker compose -f docker-compose.prod.yml pull
#   docker compose -f docker-compose.prod.yml up -d

services:
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tally-tailscale
    hostname: tally
    environment:
      # No TS_AUTHKEY = shows login link in logs (check within 60 seconds!)
      # To use auth key instead, uncomment and set:
      # - TS_AUTHKEY=tskey-auth-xxxxx
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      - TS_SERVE_CONFIG=/config/serve.json
    ports:
      - "3000:3000"
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./tailscale-config:/config:ro
    restart: unless-stopped

  web:
    image: ghcr.io/fawwaz-2009/tally:latest
    container_name: tally-web
    network_mode: service:tailscale
    depends_on:
      - tailscale
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - DATABASE_PATH=/app/data/app.db
      - BUCKET_STORAGE_PATH=/app/data/uploads
    volumes:
      - tally-data:/app/data
    restart: unless-stopped

volumes:
  tally-data:
  tailscale-state:
